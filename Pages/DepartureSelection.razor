@page "/departure"
@inject NavigationManager Navigation
@inject ILocationService LocationService
@using StationNavigation.Models
@using StationNavigation.Services

<PageTitle>ì¶œë°œì§€ ì„ íƒ - ëŒ€ì „ì—­ ê¸¸ì°¾ê¸°</PageTitle>

<div class="departure-container">
    <div class="departure-header">
        <button class="back-btn" @onclick="GoBack">
            â† ë’¤ë¡œ
        </button>
        
        <p class="station-info">ëŒ€ì „ì—­ ë‚´ ì‹œì„¤</p>
        <h1>ì¶œë°œì§€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</h1>
        <!-- ğŸ‘‡ 'ì¶œë°œì§€: ...'ë¥¼ í‘œì‹œí•˜ëŠ” ë¶ˆí•„ìš”í•œ ì½”ë“œë¥¼ ì‚­ì œí•˜ì—¬ ì˜¤ë¥˜ë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤. -->
    </div>

<div class="category-list">
    @if (isLoading)
    {
        <div class="loading-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    }
    else if (categorizedLocations.Any())
    {
        @foreach (var category in categorizedLocations.OrderBy(c => GetCategoryOrder(int.Parse(c.Key))))
        {
            <div class="category-item">
                <h3 @onclick="() => ToggleCategory(int.Parse(category.Key))" 
                    class="category-title @(selectedCategory == int.Parse(category.Key) ? "active" : "")">
                    @GetCategoryName(category.Key)
                    <span class="toggle-icon">@(selectedCategory == int.Parse(category.Key) ? "â–¼" : "â–¶")</span>
                </h3>
                @if (selectedCategory == int.Parse(category.Key))
                {
                    <div class="location-list">
                        @foreach (var location in category.Value)
                        {
                            <button class="location-btn @(IsPopularLocation(location.Name) ? "popular" : "")" 
                                    @onclick="() => SelectLocation(location.Id)">
                                @location.Name
                                @if (IsPopularLocation(location.Name))
                                {
                                    <span class="popular-badge">ì¸ê¸°</span>
                                }
                            </button>
                        }
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="no-data-message">ë“±ë¡ëœ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    }
</div>
</div>

<style>
    .departure-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: 'Noto Sans KR', sans-serif;
    }

    .departure-header {
        position: relative; /* ìì‹ ìš”ì†Œì¸ back-btnì˜ ê¸°ì¤€ì  */
        padding: 20px;
        /* back-btnì„ ìœ„í•œ ê³µê°„ì„ í™•ë³´í•˜ê³  í—¤ë” ì½˜í…ì¸ ë¥¼ ì¤‘ì•™ì— ìœ ì§€í•©ë‹ˆë‹¤. */
        padding-top: 60px; 
        color: white;
        text-align: center;
    }

    .back-btn {
        position: absolute; /* headerë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ì§€ì • */
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        /* ë²„íŠ¼ í¬ê¸°ë¥¼ ë” ì‘ê³  ì„¸ë ¨ë˜ê²Œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. */
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
    }

    .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* SVG ì•„ì´ì½˜ í¬ê¸° ì¡°ì • */
    .back-btn svg {
        width: 1.25rem;
        height: 1.25rem;
    }
    
    .back-btn span {
        margin-left: 4px;
    }

    .departure-header h1 {
        font-size: 2rem;
        margin: 0;
        font-weight: 700;
    }

    .station-info {
        /* ê¸€ì í¬ê¸°ì™€ êµµê¸°ë¥¼ ë” í‚¤ì›Œì„œ ì˜ ë³´ì´ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. */
        font-size: 1.4rem; 
        font-weight: 600;
        opacity: 0.9;
        margin: 0 0 10px 0; /* ì œëª©ê³¼ì˜ ê°„ê²© ì¡°ì • */
    }

    .category-list {
        padding: 0 20px 20px;
        max-width: 800px;
        margin: 0 auto;
    }

    .category-item {
        background: rgba(255, 255, 255, 0.95);
        margin-bottom: 15px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .category-title {
        padding: 20px;
        margin: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        transition: background-color 0.3s ease;
        user-select: none;
    }

    .category-title:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .category-title.active {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
    }

    .toggle-icon {
        font-size: 1rem;
    }

    .location-list {
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .location-btn {
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .location-btn:hover {
        border-color: #4CAF50;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        background: #f8fff8;
    }

    .location-btn.popular {
        border-color: #ff9800;
        background: linear-gradient(135deg, #fff3e0, #ffffff);
    }

    .popular-badge {
        background: #ff9800;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .loading-message, .no-data-message {
        text-align: center;
        padding: 40px;
        color: white;
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        margin: 20px;
    }

    @@media (max-width: 768px) {
        .location-list {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private Dictionary<string, List<Location>> categorizedLocations = new();
    private int selectedCategory = 1;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadLocationsAsync();
    }

    private async Task LoadLocationsAsync()
    {
        try
        {
            isLoading = true;
	    categorizedLocations.Clear();
            
            // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
            var allLocations = await LocationService.GetAllActiveLocationsAsync();

	    categorizedLocations = allLocations
            .GroupBy(location => location.CategoryId)
            .ToDictionary(group => group.Key.ToString(), group => group.ToList());



            // ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒ
            if (categorizedLocations.Any())
            {
                selectedCategory = 1;
            }
        }
        catch (Exception ex)
        {
            // ì—ëŸ¬ ì²˜ë¦¬ - ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë¡œê¹… í•„ìš”
            Console.WriteLine($"ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleCategory(int categoryId)
    {
        selectedCategory = selectedCategory == categoryId ? 0 : categoryId;
    }

    private void SelectLocation(int locationId)
    {
        Navigation.NavigateTo($"/arrival?departure={locationId}");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/region");
    }

    // ì¹´í…Œê³ ë¦¬ ìˆœì„œ ì •ì˜ (ì›í•˜ëŠ” ìˆœì„œëŒ€ë¡œ í‘œì‹œ)
    private int GetCategoryOrder(int categoryId)
    {
        return categoryId switch
        {
            1 => 1, // ê³µê³µì‹œì„¤
            2 => 2, // ê°€ê²Œ
            3 => 3, // ì…/ì¶œêµ¬
            _ => 99
        };
    }

    private string GetCategoryName(string categoryKey)
    {
        // category.Keyê°€ ë¬¸ìì—´(string)ì´ë¯€ë¡œ intë¡œ ë³€í™˜í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // GetCategoryOrder í•¨ìˆ˜ì— ì •ì˜ëœ ìˆœì„œì™€ ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ë§ì¶°ì£¼ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        return int.Parse(categoryKey) switch
        {
            1 => "ê³µê³µì‹œì„¤",
            2 => "ê°€ê²Œ",
            3 => "ì…/ì¶œêµ¬",
            _ => "ê¸°íƒ€" // ì•Œ ìˆ˜ ì—†ëŠ” ì¹´í…Œê³ ë¦¬ì¼ ê²½ìš°
        };
    }

    // ì¸ê¸° ìœ„ì¹˜ íŒë³„ (DBì— ì¸ê¸°ë„ í•„ë“œê°€ ì—†ìœ¼ë¯€ë¡œ í•˜ë“œì½”ë”©, ë‚˜ì¤‘ì— DB í•„ë“œë¡œ ë³€ê²½ ê°€ëŠ¥)
    private bool IsPopularLocation(string locationName)
    {
        var popularLocations = new[] { "ì„±ì‹¬ë‹¹", "ìŠ¤íƒ€ë²…ìŠ¤" };
        return popularLocations.Contains(locationName);
    }
}
